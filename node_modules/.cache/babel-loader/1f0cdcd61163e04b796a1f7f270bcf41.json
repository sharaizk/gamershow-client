{"ast":null,"code":"import _classCallCheck from \"D:/STREAMING_SITE/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"D:/STREAMING_SITE/client/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\n\n/*\n * Copyright (C) 2016 Bilibili. All Rights Reserved.\n *\n * @author zheng qian <xqq@xqq.im>\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport ExpGolomb from './exp-golomb.js';\n\nvar SPSParser = /*#__PURE__*/function () {\n  function SPSParser() {\n    _classCallCheck(this, SPSParser);\n  }\n\n  _createClass(SPSParser, null, [{\n    key: \"_ebsp2rbsp\",\n    value: function _ebsp2rbsp(uint8array) {\n      var src = uint8array;\n      var src_length = src.byteLength;\n      var dst = new Uint8Array(src_length);\n      var dst_idx = 0;\n\n      for (var i = 0; i < src_length; i++) {\n        if (i >= 2) {\n          // Unescape: Skip 0x03 after 00 00\n          if (src[i] === 0x03 && src[i - 1] === 0x00 && src[i - 2] === 0x00) {\n            continue;\n          }\n        }\n\n        dst[dst_idx] = src[i];\n        dst_idx++;\n      }\n\n      return new Uint8Array(dst.buffer, 0, dst_idx);\n    }\n  }, {\n    key: \"parseSPS\",\n    value: function parseSPS(uint8array) {\n      var rbsp = SPSParser._ebsp2rbsp(uint8array);\n\n      var gb = new ExpGolomb(rbsp);\n      gb.readByte();\n      var profile_idc = gb.readByte(); // profile_idc\n\n      gb.readByte(); // constraint_set_flags[5] + reserved_zero[3]\n\n      var level_idc = gb.readByte(); // level_idc\n\n      gb.readUEG(); // seq_parameter_set_id\n\n      var profile_string = SPSParser.getProfileString(profile_idc);\n      var level_string = SPSParser.getLevelString(level_idc);\n      var chroma_format_idc = 1;\n      var chroma_format = 420;\n      var chroma_format_table = [0, 420, 422, 444];\n      var bit_depth = 8;\n\n      if (profile_idc === 100 || profile_idc === 110 || profile_idc === 122 || profile_idc === 244 || profile_idc === 44 || profile_idc === 83 || profile_idc === 86 || profile_idc === 118 || profile_idc === 128 || profile_idc === 138 || profile_idc === 144) {\n        chroma_format_idc = gb.readUEG();\n\n        if (chroma_format_idc === 3) {\n          gb.readBits(1); // separate_colour_plane_flag\n        }\n\n        if (chroma_format_idc <= 3) {\n          chroma_format = chroma_format_table[chroma_format_idc];\n        }\n\n        bit_depth = gb.readUEG() + 8; // bit_depth_luma_minus8\n\n        gb.readUEG(); // bit_depth_chroma_minus8\n\n        gb.readBits(1); // qpprime_y_zero_transform_bypass_flag\n\n        if (gb.readBool()) {\n          // seq_scaling_matrix_present_flag\n          var scaling_list_count = chroma_format_idc !== 3 ? 8 : 12;\n\n          for (var i = 0; i < scaling_list_count; i++) {\n            if (gb.readBool()) {\n              // seq_scaling_list_present_flag\n              if (i < 6) {\n                SPSParser._skipScalingList(gb, 16);\n              } else {\n                SPSParser._skipScalingList(gb, 64);\n              }\n            }\n          }\n        }\n      }\n\n      gb.readUEG(); // log2_max_frame_num_minus4\n\n      var pic_order_cnt_type = gb.readUEG();\n\n      if (pic_order_cnt_type === 0) {\n        gb.readUEG(); // log2_max_pic_order_cnt_lsb_minus_4\n      } else if (pic_order_cnt_type === 1) {\n        gb.readBits(1); // delta_pic_order_always_zero_flag\n\n        gb.readSEG(); // offset_for_non_ref_pic\n\n        gb.readSEG(); // offset_for_top_to_bottom_field\n\n        var num_ref_frames_in_pic_order_cnt_cycle = gb.readUEG();\n\n        for (var _i = 0; _i < num_ref_frames_in_pic_order_cnt_cycle; _i++) {\n          gb.readSEG(); // offset_for_ref_frame\n        }\n      }\n\n      var ref_frames = gb.readUEG(); // max_num_ref_frames\n\n      gb.readBits(1); // gaps_in_frame_num_value_allowed_flag\n\n      var pic_width_in_mbs_minus1 = gb.readUEG();\n      var pic_height_in_map_units_minus1 = gb.readUEG();\n      var frame_mbs_only_flag = gb.readBits(1);\n\n      if (frame_mbs_only_flag === 0) {\n        gb.readBits(1); // mb_adaptive_frame_field_flag\n      }\n\n      gb.readBits(1); // direct_8x8_inference_flag\n\n      var frame_crop_left_offset = 0;\n      var frame_crop_right_offset = 0;\n      var frame_crop_top_offset = 0;\n      var frame_crop_bottom_offset = 0;\n      var frame_cropping_flag = gb.readBool();\n\n      if (frame_cropping_flag) {\n        frame_crop_left_offset = gb.readUEG();\n        frame_crop_right_offset = gb.readUEG();\n        frame_crop_top_offset = gb.readUEG();\n        frame_crop_bottom_offset = gb.readUEG();\n      }\n\n      var sar_width = 1,\n          sar_height = 1;\n      var fps = 0,\n          fps_fixed = true,\n          fps_num = 0,\n          fps_den = 0;\n      var vui_parameters_present_flag = gb.readBool();\n\n      if (vui_parameters_present_flag) {\n        if (gb.readBool()) {\n          // aspect_ratio_info_present_flag\n          var aspect_ratio_idc = gb.readByte();\n          var sar_w_table = [1, 12, 10, 16, 40, 24, 20, 32, 80, 18, 15, 64, 160, 4, 3, 2];\n          var sar_h_table = [1, 11, 11, 11, 33, 11, 11, 11, 33, 11, 11, 33, 99, 3, 2, 1];\n\n          if (aspect_ratio_idc > 0 && aspect_ratio_idc < 16) {\n            sar_width = sar_w_table[aspect_ratio_idc - 1];\n            sar_height = sar_h_table[aspect_ratio_idc - 1];\n          } else if (aspect_ratio_idc === 255) {\n            sar_width = gb.readByte() << 8 | gb.readByte();\n            sar_height = gb.readByte() << 8 | gb.readByte();\n          }\n        }\n\n        if (gb.readBool()) {\n          // overscan_info_present_flag\n          gb.readBool(); // overscan_appropriate_flag\n        }\n\n        if (gb.readBool()) {\n          // video_signal_type_present_flag\n          gb.readBits(4); // video_format & video_full_range_flag\n\n          if (gb.readBool()) {\n            // colour_description_present_flag\n            gb.readBits(24); // colour_primaries & transfer_characteristics & matrix_coefficients\n          }\n        }\n\n        if (gb.readBool()) {\n          // chroma_loc_info_present_flag\n          gb.readUEG(); // chroma_sample_loc_type_top_field\n\n          gb.readUEG(); // chroma_sample_loc_type_bottom_field\n        }\n\n        if (gb.readBool()) {\n          // timing_info_present_flag\n          var num_units_in_tick = gb.readBits(32);\n          var time_scale = gb.readBits(32);\n          fps_fixed = gb.readBool(); // fixed_frame_rate_flag\n\n          fps_num = time_scale;\n          fps_den = num_units_in_tick * 2;\n          fps = fps_num / fps_den;\n        }\n      }\n\n      var sarScale = 1;\n\n      if (sar_width !== 1 || sar_height !== 1) {\n        sarScale = sar_width / sar_height;\n      }\n\n      var crop_unit_x = 0,\n          crop_unit_y = 0;\n\n      if (chroma_format_idc === 0) {\n        crop_unit_x = 1;\n        crop_unit_y = 2 - frame_mbs_only_flag;\n      } else {\n        var sub_wc = chroma_format_idc === 3 ? 1 : 2;\n        var sub_hc = chroma_format_idc === 1 ? 2 : 1;\n        crop_unit_x = sub_wc;\n        crop_unit_y = sub_hc * (2 - frame_mbs_only_flag);\n      }\n\n      var codec_width = (pic_width_in_mbs_minus1 + 1) * 16;\n      var codec_height = (2 - frame_mbs_only_flag) * ((pic_height_in_map_units_minus1 + 1) * 16);\n      codec_width -= (frame_crop_left_offset + frame_crop_right_offset) * crop_unit_x;\n      codec_height -= (frame_crop_top_offset + frame_crop_bottom_offset) * crop_unit_y;\n      var present_width = Math.ceil(codec_width * sarScale);\n      gb.destroy();\n      gb = null;\n      return {\n        profile_string: profile_string,\n        // baseline, high, high10, ...\n        level_string: level_string,\n        // 3, 3.1, 4, 4.1, 5, 5.1, ...\n        bit_depth: bit_depth,\n        // 8bit, 10bit, ...\n        ref_frames: ref_frames,\n        chroma_format: chroma_format,\n        // 4:2:0, 4:2:2, ...\n        chroma_format_string: SPSParser.getChromaFormatString(chroma_format),\n        frame_rate: {\n          fixed: fps_fixed,\n          fps: fps,\n          fps_den: fps_den,\n          fps_num: fps_num\n        },\n        sar_ratio: {\n          width: sar_width,\n          height: sar_height\n        },\n        codec_size: {\n          width: codec_width,\n          height: codec_height\n        },\n        present_size: {\n          width: present_width,\n          height: codec_height\n        }\n      };\n    }\n  }, {\n    key: \"_skipScalingList\",\n    value: function _skipScalingList(gb, count) {\n      var last_scale = 8,\n          next_scale = 8;\n      var delta_scale = 0;\n\n      for (var i = 0; i < count; i++) {\n        if (next_scale !== 0) {\n          delta_scale = gb.readSEG();\n          next_scale = (last_scale + delta_scale + 256) % 256;\n        }\n\n        last_scale = next_scale === 0 ? last_scale : next_scale;\n      }\n    }\n  }, {\n    key: \"getProfileString\",\n    value: function getProfileString(profile_idc) {\n      switch (profile_idc) {\n        case 66:\n          return 'Baseline';\n\n        case 77:\n          return 'Main';\n\n        case 88:\n          return 'Extended';\n\n        case 100:\n          return 'High';\n\n        case 110:\n          return 'High10';\n\n        case 122:\n          return 'High422';\n\n        case 244:\n          return 'High444';\n\n        default:\n          return 'Unknown';\n      }\n    }\n  }, {\n    key: \"getLevelString\",\n    value: function getLevelString(level_idc) {\n      return (level_idc / 10).toFixed(1);\n    }\n  }, {\n    key: \"getChromaFormatString\",\n    value: function getChromaFormatString(chroma) {\n      switch (chroma) {\n        case 420:\n          return '4:2:0';\n\n        case 422:\n          return '4:2:2';\n\n        case 444:\n          return '4:4:4';\n\n        default:\n          return 'Unknown';\n      }\n    }\n  }]);\n\n  return SPSParser;\n}();\n\nexport default SPSParser;","map":{"version":3,"sources":["D:/STREAMING_SITE/client/node_modules/flv.js/src/demux/sps-parser.js"],"names":["ExpGolomb","SPSParser","uint8array","src","src_length","byteLength","dst","Uint8Array","dst_idx","i","buffer","rbsp","_ebsp2rbsp","gb","readByte","profile_idc","level_idc","readUEG","profile_string","getProfileString","level_string","getLevelString","chroma_format_idc","chroma_format","chroma_format_table","bit_depth","readBits","readBool","scaling_list_count","_skipScalingList","pic_order_cnt_type","readSEG","num_ref_frames_in_pic_order_cnt_cycle","ref_frames","pic_width_in_mbs_minus1","pic_height_in_map_units_minus1","frame_mbs_only_flag","frame_crop_left_offset","frame_crop_right_offset","frame_crop_top_offset","frame_crop_bottom_offset","frame_cropping_flag","sar_width","sar_height","fps","fps_fixed","fps_num","fps_den","vui_parameters_present_flag","aspect_ratio_idc","sar_w_table","sar_h_table","num_units_in_tick","time_scale","sarScale","crop_unit_x","crop_unit_y","sub_wc","sub_hc","codec_width","codec_height","present_width","Math","ceil","destroy","chroma_format_string","getChromaFormatString","frame_rate","fixed","sar_ratio","width","height","codec_size","present_size","count","last_scale","next_scale","delta_scale","toFixed","chroma"],"mappings":"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","sourcesContent":["/*\n * Copyright (C) 2016 Bilibili. All Rights Reserved.\n *\n * @author zheng qian <xqq@xqq.im>\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport ExpGolomb from './exp-golomb.js';\n\nclass SPSParser {\n\n    static _ebsp2rbsp(uint8array) {\n        let src = uint8array;\n        let src_length = src.byteLength;\n        let dst = new Uint8Array(src_length);\n        let dst_idx = 0;\n\n        for (let i = 0; i < src_length; i++) {\n            if (i >= 2) {\n                // Unescape: Skip 0x03 after 00 00\n                if (src[i] === 0x03 && src[i - 1] === 0x00 && src[i - 2] === 0x00) {\n                    continue;\n                }\n            }\n            dst[dst_idx] = src[i];\n            dst_idx++;\n        }\n\n        return new Uint8Array(dst.buffer, 0, dst_idx);\n    }\n\n    static parseSPS(uint8array) {\n        let rbsp = SPSParser._ebsp2rbsp(uint8array);\n        let gb = new ExpGolomb(rbsp);\n\n        gb.readByte();\n        let profile_idc = gb.readByte();  // profile_idc\n        gb.readByte();  // constraint_set_flags[5] + reserved_zero[3]\n        let level_idc = gb.readByte();  // level_idc\n        gb.readUEG();  // seq_parameter_set_id\n\n        let profile_string = SPSParser.getProfileString(profile_idc);\n        let level_string = SPSParser.getLevelString(level_idc);\n        let chroma_format_idc = 1;\n        let chroma_format = 420;\n        let chroma_format_table = [0, 420, 422, 444];\n        let bit_depth = 8;\n\n        if (profile_idc === 100 || profile_idc === 110 || profile_idc === 122 ||\n            profile_idc === 244 || profile_idc === 44 || profile_idc === 83 ||\n            profile_idc === 86 || profile_idc === 118 || profile_idc === 128 ||\n            profile_idc === 138 || profile_idc === 144) {\n\n            chroma_format_idc = gb.readUEG();\n            if (chroma_format_idc === 3) {\n                gb.readBits(1);  // separate_colour_plane_flag\n            }\n            if (chroma_format_idc <= 3) {\n                chroma_format = chroma_format_table[chroma_format_idc];\n            }\n\n            bit_depth = gb.readUEG() + 8;  // bit_depth_luma_minus8\n            gb.readUEG();  // bit_depth_chroma_minus8\n            gb.readBits(1);  // qpprime_y_zero_transform_bypass_flag\n            if (gb.readBool()) {  // seq_scaling_matrix_present_flag\n                let scaling_list_count = (chroma_format_idc !== 3) ? 8 : 12;\n                for (let i = 0; i < scaling_list_count; i++) {\n                    if (gb.readBool()) {  // seq_scaling_list_present_flag\n                        if (i < 6) {\n                            SPSParser._skipScalingList(gb, 16);\n                        } else {\n                            SPSParser._skipScalingList(gb, 64);\n                        }\n                    }\n                }\n            }\n        }\n        gb.readUEG();  // log2_max_frame_num_minus4\n        let pic_order_cnt_type = gb.readUEG();\n        if (pic_order_cnt_type === 0) {\n            gb.readUEG();  // log2_max_pic_order_cnt_lsb_minus_4\n        } else if (pic_order_cnt_type === 1) {\n            gb.readBits(1);  // delta_pic_order_always_zero_flag\n            gb.readSEG();  // offset_for_non_ref_pic\n            gb.readSEG();  // offset_for_top_to_bottom_field\n            let num_ref_frames_in_pic_order_cnt_cycle = gb.readUEG();\n            for (let i = 0; i < num_ref_frames_in_pic_order_cnt_cycle; i++) {\n                gb.readSEG();  // offset_for_ref_frame\n            }\n        }\n        let ref_frames = gb.readUEG();  // max_num_ref_frames\n        gb.readBits(1);  // gaps_in_frame_num_value_allowed_flag\n\n        let pic_width_in_mbs_minus1 = gb.readUEG();\n        let pic_height_in_map_units_minus1 = gb.readUEG();\n\n        let frame_mbs_only_flag = gb.readBits(1);\n        if (frame_mbs_only_flag === 0) {\n            gb.readBits(1);  // mb_adaptive_frame_field_flag\n        }\n        gb.readBits(1);  // direct_8x8_inference_flag\n\n        let frame_crop_left_offset = 0;\n        let frame_crop_right_offset = 0;\n        let frame_crop_top_offset = 0;\n        let frame_crop_bottom_offset = 0;\n\n        let frame_cropping_flag = gb.readBool();\n        if (frame_cropping_flag) {\n            frame_crop_left_offset = gb.readUEG();\n            frame_crop_right_offset = gb.readUEG();\n            frame_crop_top_offset = gb.readUEG();\n            frame_crop_bottom_offset = gb.readUEG();\n        }\n\n        let sar_width = 1, sar_height = 1;\n        let fps = 0, fps_fixed = true, fps_num = 0, fps_den = 0;\n\n        let vui_parameters_present_flag = gb.readBool();\n        if (vui_parameters_present_flag) {\n            if (gb.readBool()) {  // aspect_ratio_info_present_flag\n                let aspect_ratio_idc = gb.readByte();\n                let sar_w_table = [1, 12, 10, 16, 40, 24, 20, 32, 80, 18, 15, 64, 160, 4, 3, 2];\n                let sar_h_table = [1, 11, 11, 11, 33, 11, 11, 11, 33, 11, 11, 33,  99, 3, 2, 1];\n\n                if (aspect_ratio_idc > 0 && aspect_ratio_idc < 16) {\n                    sar_width = sar_w_table[aspect_ratio_idc - 1];\n                    sar_height = sar_h_table[aspect_ratio_idc - 1];\n                } else if (aspect_ratio_idc === 255) {\n                    sar_width = gb.readByte() << 8 | gb.readByte();\n                    sar_height = gb.readByte() << 8 | gb.readByte();\n                }\n            }\n\n            if (gb.readBool()) {  // overscan_info_present_flag\n                gb.readBool();  // overscan_appropriate_flag\n            }\n            if (gb.readBool()) {  // video_signal_type_present_flag\n                gb.readBits(4);  // video_format & video_full_range_flag\n                if (gb.readBool()) {  // colour_description_present_flag\n                    gb.readBits(24);  // colour_primaries & transfer_characteristics & matrix_coefficients\n                }\n            }\n            if (gb.readBool()) {  // chroma_loc_info_present_flag\n                gb.readUEG();  // chroma_sample_loc_type_top_field\n                gb.readUEG();  // chroma_sample_loc_type_bottom_field\n            }\n            if (gb.readBool()) {  // timing_info_present_flag\n                let num_units_in_tick = gb.readBits(32);\n                let time_scale = gb.readBits(32);\n                fps_fixed = gb.readBool();  // fixed_frame_rate_flag\n\n                fps_num = time_scale;\n                fps_den = num_units_in_tick * 2;\n                fps = fps_num / fps_den;\n            }\n        }\n\n        let sarScale = 1;\n        if (sar_width !== 1 || sar_height !== 1) {\n            sarScale = sar_width / sar_height;\n        }\n\n        let crop_unit_x = 0, crop_unit_y = 0;\n        if (chroma_format_idc === 0) {\n            crop_unit_x = 1;\n            crop_unit_y = 2 - frame_mbs_only_flag;\n        } else {\n            let sub_wc = (chroma_format_idc === 3) ? 1 : 2;\n            let sub_hc = (chroma_format_idc === 1) ? 2 : 1;\n            crop_unit_x = sub_wc;\n            crop_unit_y = sub_hc * (2 - frame_mbs_only_flag);\n        }\n\n        let codec_width = (pic_width_in_mbs_minus1 + 1) * 16;\n        let codec_height = (2 - frame_mbs_only_flag) * ((pic_height_in_map_units_minus1 + 1) * 16);\n\n        codec_width -= (frame_crop_left_offset + frame_crop_right_offset) * crop_unit_x;\n        codec_height -= (frame_crop_top_offset + frame_crop_bottom_offset) * crop_unit_y;\n\n        let present_width = Math.ceil(codec_width * sarScale);\n\n        gb.destroy();\n        gb = null;\n\n        return {\n            profile_string: profile_string,  // baseline, high, high10, ...\n            level_string: level_string,  // 3, 3.1, 4, 4.1, 5, 5.1, ...\n            bit_depth: bit_depth,  // 8bit, 10bit, ...\n            ref_frames: ref_frames,\n            chroma_format: chroma_format,  // 4:2:0, 4:2:2, ...\n            chroma_format_string: SPSParser.getChromaFormatString(chroma_format),\n\n            frame_rate: {\n                fixed: fps_fixed,\n                fps: fps,\n                fps_den: fps_den,\n                fps_num: fps_num\n            },\n\n            sar_ratio: {\n                width: sar_width,\n                height: sar_height\n            },\n\n            codec_size: {\n                width: codec_width,\n                height: codec_height\n            },\n\n            present_size: {\n                width: present_width,\n                height: codec_height\n            }\n        };\n    }\n\n    static _skipScalingList(gb, count) {\n        let last_scale = 8, next_scale = 8;\n        let delta_scale = 0;\n        for (let i = 0; i < count; i++) {\n            if (next_scale !== 0) {\n                delta_scale = gb.readSEG();\n                next_scale = (last_scale + delta_scale + 256) % 256;\n            }\n            last_scale = (next_scale === 0) ? last_scale : next_scale;\n        }\n    }\n\n    static getProfileString(profile_idc) {\n        switch (profile_idc) {\n            case 66:\n                return 'Baseline';\n            case 77:\n                return 'Main';\n            case 88:\n                return 'Extended';\n            case 100:\n                return 'High';\n            case 110:\n                return 'High10';\n            case 122:\n                return 'High422';\n            case 244:\n                return 'High444';\n            default:\n                return 'Unknown';\n        }\n    }\n\n    static getLevelString(level_idc) {\n        return (level_idc / 10).toFixed(1);\n    }\n\n    static getChromaFormatString(chroma) {\n        switch (chroma) {\n            case 420:\n                return '4:2:0';\n            case 422:\n                return '4:2:2';\n            case 444:\n                return '4:4:4';\n            default:\n                return 'Unknown';\n        }\n    }\n\n}\n\nexport default SPSParser;"]},"metadata":{},"sourceType":"module"}